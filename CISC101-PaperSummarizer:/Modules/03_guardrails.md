# Module 03 – Guardrails

## Change Log
- 2025-11-28: Introduced `evidence_mode` with support for `"strict"` behavior.
- 2025-11-28: Added standardized warning messages for missing and very short sections, and clarified hallucination-mitigation rules.

---

## Purpose

Module 03 is responsible for **safety, evidence, and warnings**.  
It reviews the section summaries generated by Module 02 and makes sure they:

- only rely on information actually present in the paper,
- clearly indicate when sections are missing or too short,
- expose any evidence limitations to the user, and
- pass back a clean, flagged data structure to Module 04 for rendering.

---

## Inputs

From Module 01 and Module 02:

- `section_summaries`: list of section summary records produced by Module 02, each containing:
  - `section_id`
  - `section_title`
  - `section_summary_text`
  - optional `key_points`
  - status flags (e.g., `"missing"`, `"too_short"`)

- `evidence_mode`: string flag controlling strictness of evidence handling.  
  Allowed values:
  - `"normal"` (default)
  - `"strict"`

- Original section texts or references to them (so this module can reason about whether a claim is supported by the input).

---

## Outputs

Module 03 returns:

- `validated_section_summaries`:  
  section summaries with additional metadata and warnings attached.

- `global_warnings`:  
  a list of messages that should be surfaced in the final output (e.g., explaining that some sections were skipped, too short, or lacked enough information under strict evidence mode).

These outputs are consumed by Module 04 when building the final report.

---

## Workflow

1. **Initialize data structures**
   - Start with an empty list `validated_section_summaries`.
   - Start with an empty list `global_warnings`.

2. **Loop over each `section_summary` record**:
   - Read `status` flags from Module 01 / 02 (e.g., `"ok"`, `"missing"`, `"too_short"`).

3. **Handle missing sections**
   - If the section was marked as missing or has no usable text:
     - Do **not** fabricate a summary.
     - Attach a standardized warning message to that section:
       - `"Section skipped: no usable text was provided."`
     - Add the same message (with the section title) to `global_warnings`.

4. **Handle very short sections (< 50 words)**
   - If the section was flagged as `"too_short"`:
     - Keep the summary generated by Module 02, but attach a warning:
       - `"Section very short: summary may be incomplete."`
     - Add a similar note to `global_warnings` so the user understands the limitation.

5. **Apply `evidence_mode` rules**

   - If `evidence_mode = "normal"`:
     - Remind the model to avoid speculation and stick to the source text, but allow reasonable paraphrasing.
     - Encourage conservative interpretation of vague or underspecified passages.

   - If `evidence_mode = "strict"`:
     - Enforce a much tighter rule:
       - Only include claims, equations, definitions, and results that are **explicitly** present in the provided text.
       - Do not fill in gaps with background knowledge or “common sense.”
     - For any section where the model cannot confidently trace claims to the text:
       - Replace or prefix the section summary with a standardized message such as:
         - `"The source text does not provide enough detail to summarize this section in strict evidence mode."`
       - Add a corresponding entry to `global_warnings` identifying the section.

6. **Hallucination-mitigation pass**
   - For each section summary:
     - Re-check that all key points and bullet items are clearly grounded in the original `section_text`.
     - If a bullet point or sentence seems speculative or unrelated to the section, instruct the model to:
       - remove or rewrite it so that it only reflects content from the paper.
   - Record any adjustments in internal comments if needed (not shown to the user).

7. **Finalize validated records**
   - For each section:
     - Attach any warning messages as metadata so Module 04 can display them clearly (e.g., below the section summary or in a “Checks & Warnings” section).
     - Append the updated record to `validated_section_summaries`.

8. **Return results to Module 04**
   - Pass `validated_section_summaries` and `global_warnings` to Module 04 for incorporation into:
     - the section-by-section table,
     - the main paper summary,
     - the “Checks & Warnings” output area.

---

## Rules & Constraints

- This module must **never** encourage fabrication of content.
- Under `"strict"` evidence mode:
  - Missing or vague information should be exposed honestly using the standardized strict-mode message.
- Standard warning messages must be used consistently:
  - Missing: `"Section skipped: no usable text was provided."`
  - Too short: `"Section very short: summary may be incomplete."`
- All behavior must remain compatible with the PS2 specification:
  - no added facts,
  - clear communication of limitations,
  - and transparent signaling of any sections that could not be fully summarized.
